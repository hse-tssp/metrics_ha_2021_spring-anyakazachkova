---
title: "home_assignment"
authors: Казачкова Анна, Никонова Евгения - БЭК 181
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Казачкова Анна, Никонова Евгения - БЭК 181

Задания 6-10 выполнены в R.

#### № 6 

Была скачана объединенная база данных для домохозяйств RLMS в формате .dta, ее открыли в STATA-16 и выгрузили в виде .xlsx следующие переменные:

+ ID_W - год проведения исследования
* ID_H - идентификационная переменная
* nfm - количество членов семьи
* C5 - cколько квадратных метров составляет площадь только жилых комнат у семьи
* E1_36B - cколько килограмм сыра, брынзы семья купила в течение последних 7 дней

В Excel - файле была произведена следующая замена для переменных C5, E1_36B: вместо *"Затрудняюсь ответить"*, *"Нет ответа"*, *"Отказ от ответа"* было проставлены нули.

Затем датасет был выгружен в формате .csv и назван *"data_ha.csv"*.

```{r}
setwd("D:/ha")
data_ha <- read.table("Data_ha.csv", sep = ";", dec = ",", header = TRUE)
head(data_ha)
```
#### № 7
Самый главный вопрос: **"Поможет ли величина потребления сыра одного члена семьи предсказать размер жилой площади на одного человека?"**

#### № 8
Подготавливаем данные:
1. Для удобства переименнуем переменные
```{r}
names(data_ha)[1] <- "year"
names(data_ha)[2] <- "id"
names(data_ha)[3] <- "n_mem"
names(data_ha)[4] <- "liv_area"
names(data_ha)[5] <- "kg_cheese"
```

Смотрим, правильный ли тип данных определелился:
```{r}
str(data_ha)
```

R корректно определил формат данных.

2. Удалим из датасета все наблюдения, в которых нет данных по площади жилого помещения и потребления сыра
```{r}
data_ha <- data_ha[data_ha[4] > 0, ]
data_ha <- data_ha[data_ha[5] > 0, ]
```

3. Удалим все строки с пропущенными значениями, 
так как нас интересует выборка, где есть данные и по жилой площади, и по потреблению сыра

```{r}
data_ha <- na.omit(data_ha)
```

Посмотрим, сколько наблюдений осталось:
```{r}
str(data_ha)
```

На период с 1994 по 2019 год у нас осталось 53 764 наблюдения, этого количества достаточно для нашего исследования.

4. Вычислим для каждого наблюдения величины жилой площади и потребления сыра на 1 члена семьи
```{r}
data_ha$av_liv_area <- round(data_ha$liv_area / data_ha$n_mem, 2)
data_ha$av_kg_cheese <- round(data_ha$kg_cheese / data_ha$n_mem,2)
```

5. Теперь удалим уже ненужные столбцы с количеством человек в семье, жилой площадью и потреблением сыра на всю семью

```{r}
data_ha <- data_ha[,-c(3,4,5)]
```

```{r}
head(data_ha)
```

**Теперь датасет готов к дальнейшему исследованию!**

Для работы с панельными данными нам понадобится библиотека: *plm*
```{r}
#install.packages("plm")
library("plm")
```
Также пригодится *tidyverse* для построения графиков:
```{r}
#install.packages("tidyverse")
library("tidyverse")
```

Понадобится пакет *cowplot* для вывода графиков вместе.
```{r}

#install.packages("cowplot")
library("cowplot")
```

Преобразуем наш датасет в новый с помощью команды из библиотеки *plm*:
```{r}
h <- pdata.frame(data_ha,
                 index = c("id", "year"),
                 row.names = TRUE)

head(h)
```

Проверим, сбалансированна ли панель данных:
```{r}
h %>%
  is.pbalanced()
```

False - значит, панель не сбалансированна - исследуемые домохозяйства меняются с течением времени. Тогда, например, нет смысла делать графики для каждого отдельного домохозяйства, так как не будет данных на все года.

Построим графики с распредлением наблюдений по годам (будут показаны точками значения в каждой семье) со средним значением за каждый год для жилой площади и потребления сыра на 1 человека в семье.

Сначала для размера жилой площади:
```{r}
mean_a <- 
  h %>%
  group_by(year) %>%
  summarise(mean_area = mean(av_liv_area))

mean_a

```

Находим среднее значение показателя для каждого года.

Строим график, где среднее значение будет выделено синей линией.
```{r}
ggplot(data = h, 
       aes(x = year, y = av_liv_area)) +
  geom_point(alpha=0.05) +
  geom_line(data = mean_a, aes(x = year, y = mean_area), group = 1,col = "blue") +
  labs(x = "Год", y = "Жилая площадь на 1 человека в семье (кв. м)") +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle ("Размеры жилой площади по годам со средним значением")

```

Аналогично делаем график для потребления сыра:
```{r}
mean_c <- 
  h %>%
  group_by(year) %>%
  summarise(mean_cheese = mean(av_kg_cheese))
  
ggplot(data = h, 
         aes(x = year, y = av_kg_cheese)) +
  geom_point(alpha=0.05) +
  geom_line(data = mean_c,aes(x = year, y = mean_cheese), group = 1,col = "red") +
  labs(x = "Год", y = "Потребление сыра на 1 человека в семье (кг)") +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle ("Потребление сыра по годам со средним значением")
```

К сожалению, данные графики неудобны для визуального исследования. По ним невозможно сделать выводы на данном этапе.

Попытка перейти к логарифмам не меняет сильно ситуацию, среднее значение остается практически стабильным для обоих показателей.

```{r}
mean_a_log <- 
  h %>%
  group_by(year) %>%
  summarise(mean_area = mean(log(av_liv_area)))

p1 <- ggplot(data = h, 
       aes(x = year, y = log(av_liv_area))) +
  geom_point(alpha=0.05) +
  geom_line(data = mean_a_log,aes(x = year, y = mean_area), group = 1,col = "blue") +
  labs(x = "Год", y = "Логарифм жилой площади на 1 человека") +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle ("Логарифм жилой площади")

mean_c_log <- 
  h %>%
  group_by(year) %>%
  summarise(mean_cheese = mean(log(1+av_kg_cheese)))
  
p2 <- ggplot(data = h, 
         aes(x = year, y = log(1+av_kg_cheese))) +
  geom_point(alpha=0.05) +
  geom_line(data = mean_c_log,aes(x = year, y = mean_cheese), group = 1,col = "red") +
  labs(x = "Год", y = "Логарифм потребления сыра на 1 человека") +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle ("Логарифм потребления сыра")

plot_grid(p1, p2,align = "h", nrow = 1, rel_widths = c(1, 1), rel_heights = c(1, 1))
```

Попробуем построить график с потреблением сыра и жилой площадью на осях, цветами будут обозначены различные года.
Также на графике будет видна линейная регрессия.
```{r}
ggplot(data = data_ha, 
       aes(x = av_kg_cheese, y = av_liv_area, color = year))+
  geom_point(alpha=0.2) + labs(x = "Потребление сыра", y = "Жилая площадь")+ geom_smooth(method = "lm", se = F) + scale_color_gradientn(colours = rainbow(5)) + labs(color='Год') +
  ggtitle ("Потребление сыра и жилая площадь по годам")
```

Переход к логарифмам не меняет существенно ситуацию. Значения последних лет накладываются на предыдущие и всё перекрывают.

```{r}
ggplot(data = data_ha, 
       aes(x = log(1+av_kg_cheese), y = log(av_liv_area), color = year))+
  geom_point(alpha=0.2) + geom_smooth(method = "lm", se = F) + labs(x = "Логарифм потребления сыра", y = "Логарифм жилой площади")+ labs(color='Год')+ scale_color_gradientn(colours = rainbow(5)) +
  ggtitle ("Потребление сыра и жилая площадь в логарифмах по годам")
```

Также посмотрим отдельные показатели по годам:

```{r}
ggplot(data = data_ha, 
       aes(x =av_kg_cheese, y = av_liv_area ,color=as.factor(year) ))+
  geom_point(alpha=0.05, size = 0.5) + geom_smooth(method = "lm", se = F, lty = "dashed", color = 'black',size = 0.5) +  facet_wrap(~year) + labs(x = "Потребление сыра", y = "Жилая площадь") + ggtitle ("Потребление сыра и жилая площадь по годам") + theme(legend.position="none")
```
```{r}
ggplot(data = data_ha, 
       aes(x = log(1+av_kg_cheese), y = log(av_liv_area),color=as.factor(year) ))+
  geom_point(alpha=0.05, size = 0.5) + geom_smooth(method = "lm", se = F, lty = "dashed", color = 'black', size = 0.5) + facet_wrap(~year) + labs(x = "Логарифм потребления сыра", y = "Логарифм жилой площади") + 
  ggtitle ("Потребление сыра и жилая площадь в логарифмах по годам")+ theme(legend.position="none")
```

Отметим, что со временем потребление сыра и жилая площадь почти не меняются. Поэтому сложно сказать, связаны ли эти параметры и можно ли с помощью одного предсказать второй.

#### № 9
Составим 3 модели: сквозную (pooled), с рандомными (re) и фиксированными эффектами (fe).
```{r}
h.pooled <- plm(av_liv_area ~ av_kg_cheese, data = h, model = "pooling")
h.re <- plm(av_liv_area ~ av_kg_cheese, data = h, model = "random")
h.fe <- plm(av_liv_area ~ av_kg_cheese, data = h, model = "within")
```

Выведем результаты для них:

```{r}
summary(h.pooled)
```
```{r}
summary(h.re)
```
```{r}
summary(h.fe)
```
Коэффициенты в 3 моделях различаются, везде являются значимыми.

Сравним эти модели:

1. F-тест - FE против сквозной регрессии

```{r}
pFtest(h.fe, h.pooled)
```

Нулевая гипотеза в этом тесте - сквозная модель верна. H0 отвергается в пользу альтернативной гипотезы о верности модели FE.

2. Тест Хаусмана - FE против RE
```{r}
phtest(h.fe, h.re)
```

Значение p-value очень мало, нулевая гипотеза отвергается на любом адекватном уровне значимости, то есть в RE оценки несостоятельны.

3. Тест Бройша-Пагана - RE против сквозной регрессии.
```{r}
plmtest(h.re, type = "bp")
```

Здесь не отвергается альтернативная гипотеза, то есть c_i не равны 0 в сквозной регрессии (регрессия не верна).

**Вывод:**

Согласно трем проведенным тестам FE - наилучшая модель. Коэффициент при av_kg_cheese значим и равнятся 8,17. Однако, R^2 у регрессии очень мал (меньше 5%), что означает плохую предсказывающую способность регрессии и возможную нехватку предикторов в модели.

#### № 10

**Ответ на самый главный вопрос:**

Согласно проведенной выше работе, потребление сыра на 1 члена в семье не помогает предсказать размер жилой площади на одного человека в семье.



